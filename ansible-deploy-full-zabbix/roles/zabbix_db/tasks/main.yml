- name: Set Zabbix repo architecture
  ansible.builtin.set_fact:
    zabbix_arch: "{{ zabbix_arch_map.get(ansible_facts['architecture'], 'x86_64') }}"
    timescaledb_supported: "{{ ansible_facts['architecture'] in ['x86_64', 'amd64'] }}"
  vars:
    zabbix_arch_map:
      aarch64: aarch64
      arm64: aarch64
      x86_64: x86_64
      amd64: x86_64

- name: Importar repositório Zabbix
  ansible.builtin.yum:
    name: "https://repo.zabbix.com/zabbix/7.0/rhel/9/{{ zabbix_arch }}/zabbix-release-7.0-5.el9.noarch.rpm"
    state: present
    disable_gpg_check: true

- name: Ensure zabbix user exists
  ansible.builtin.user:
    name: zabbix
    state: present

- name: Allow zabbix user to use sudo without a password
  ansible.builtin.copy:
    dest: /etc/sudoers.d/zabbix
    content: |
      zabbix ALL=(ALL) NOPASSWD:ALL
    owner: root
    group: root
    mode: '0440'

- name: Instalar pacotes Zabbix
  ansible.builtin.yum:
    name:
      - zabbix-server-pgsql
      - zabbix-sql-scripts
    state: present

- name: Instalar pacotes necessários
  ansible.builtin.yum:
    name:
      - python3-psycopg2
    state: present

- name: Atualizar shared_preload_libraries no postgresql.conf
  ansible.builtin.lineinfile:
    path: /var/lib/pgsql/16/data/postgresql.conf
    regexp: '^shared_preload_libraries'
    line: "shared_preload_libraries = 'timescaledb'"
    insertafter: '^#.*shared_preload_libraries'
  when: timescaledb_supported

- name: Remover timescaledb do shared_preload_libraries quando não suportado
  ansible.builtin.lineinfile:
    path: /var/lib/pgsql/16/data/postgresql.conf
    regexp: '^shared_preload_libraries'
    line: "shared_preload_libraries = ''"
    insertafter: '^#.*shared_preload_libraries'
  when: not timescaledb_supported

- name: Reiniciar o serviço PostgreSQL
  ansible.builtin.systemd:
    name: postgresql-16
    state: restarted

- name: Criar usuário Zabbix no PostgreSQL
  community.postgresql.postgresql_user:
    name: zabbix
    password: 'zbx_password'
    role_attr_flags: LOGIN
    state: present
  become_user: postgres

- name: Criar banco de dados do Zabbix
  community.postgresql.postgresql_db:
    name: zbx_prod
    owner: zabbix
    encoding: UTF8
    template: template0
    state: present
  become_user: postgres

- name: Habilitar extensão TimescaleDB no banco Zabbix
  ansible.builtin.shell: >
    echo "CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;" | psql zbx_prod
  args:
    executable: /bin/bash
  become_user: postgres
  when: timescaledb_supported

- name: Importar script TimescaleDB para o banco Zabbix
  ansible.builtin.shell: >
    cat /usr/share/zabbix-sql-scripts/postgresql/timescaledb/schema.sql | psql zbx_prod
  args:
    executable: /bin/bash
  become_user: postgres
  when: timescaledb_supported
